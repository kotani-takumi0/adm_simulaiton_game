<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Policy Game | 予算推定デモ</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="app-light.css" />
  <script>
    const api = (path, init) => fetch(path, init).then(async r => {
      const text = await r.text();
      let data; try { data = JSON.parse(text); } catch { data = text; }
      if (!r.ok) {
        throw { status: r.status, data };
      }
      return data;
    });

    async function loadInfo() {
      const out = document.getElementById('info');
      out.textContent = 'loading...';
      try {
        const info = await api('/v1/budget/model_info');
        out.textContent = JSON.stringify(info, null, 2);
        const dim = info.x_dim;
        document.getElementById('dim').textContent = `x_dim=${dim}, items=${info.n_items}`;
      } catch (e) {
        out.textContent = `error: ${e.status} \n` + JSON.stringify(e.data, null, 2);
      }
    }

    function yen(n) {
      if (n === null || n === undefined || isNaN(n)) return '';
      try {
        const v = Math.round(Number(n));
        return v.toLocaleString('ja-JP');
      } catch {
        return String(n);
      }
    }

    async function predictText() {
      const hidden = document.getElementById('query_text');
      const fromHidden = hidden ? (hidden.value || '') : '';
      const fromInput = (document.getElementById('input_gaiyo')?.value || '');
      const t = (fromHidden || fromInput || '').trim();
      const out = document.getElementById('pred');
      out.textContent = 'predicting (text)...';
      if (!t) {
        out.textContent = '入力が空です。事業の概要を入力してください。';
        return;
      }
      try {
        const res = await api('/v1/budget/predict', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query_text: t })
        });
        // Render pretty output (推定当初予算のみ)
        let html = '';
        html += `
<section class="summary-kpi-section">
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">💰</div>
      <div class="kpi-content">
        <h3>推定当初予算</h3>
        <div class="kpi-value">${yen(res.estimate_initial)} 円</div>
      </div>
    </div>
  </div>
</section>`;
        // 実データ確認ボタンは右ペインの固定ボタンを使用（ここでは追加しない）
        
        html += '<br/>';
        html += '<div class="card-title" style="margin-top:8px">類似事業</div>';
        if (Array.isArray(res.topk) && res.topk.length) {
          html += '<div class="projects-list">';
          for (const r of res.topk) {
            const sim = Number(r.similarity ?? 0);
            const sim01 = Math.max(0, Math.min(1, (sim + 1) / 2));
            const simPct = (sim01*100).toFixed(0);
            const name = (r.name ?? '');
            html += `
              <div class=\"project-item${r.rank===1 ? ' top1' : ''}">
                <div class="project-header">
                  <span class="rank-badge">#${r.rank}</span>
                  <span class="project-name">${name}</span>
                </div>
                <div class="simbar"><div class="simbar-fill" style="width:${simPct}%"></div></div>
                <div class="project-rating">
                  <span class="sim">sim ${(sim).toFixed(3)} (${simPct}%)</span>
                  <span class="y0">当初 ${yen(r.initial_budget)}</span>
                </div>
              </div>`;
          }
          html += '</div>';
        } else {
          html += '<div class="muted">類似事業はありません</div>';
        }
        out.innerHTML = html;
        // Attach click handlers to similar project cards
        try {
          window.LAST_PRED = res;
          const cards = out.querySelectorAll('.project-item');
          cards.forEach((el, i) => {
            const bid = (res.topk && res.topk[i] && res.topk[i].budget_id) ? String(res.topk[i].budget_id) : '';
            el.dataset.bid = bid;
            if (bid) {
              el.style.cursor = 'pointer';
              el.addEventListener('click', () => openProjectDetail(el.dataset.bid));
            } else {
              el.title = 'IDが無いため詳細を表示できません';
            }
          });
        } catch {}
      } catch (e) {
        out.textContent = `error: ${e.status} \n` + JSON.stringify(e.data, null, 2);
      }
    }

    async function startSession() {
      const out = document.getElementById('session');
      const metaOut = document.getElementById('start_events_meta');
      out.textContent = 'starting...';
      metaOut.innerHTML = '';
      try {
        const idsRaw = document.getElementById('event_ids_input').value.trim();
        let body = undefined;
        if (idsRaw) {
          const ids = idsRaw.split(',').map(s=>s.trim()).filter(Boolean);
          body = JSON.stringify({ event_ids: ids });
        }
        const s = await api('/v1/state/start', {
          method: 'POST', headers: body? { 'Content-Type': 'application/json' } : undefined, body
        });
        out.textContent = JSON.stringify(s, null, 2);
        document.getElementById('session_id').textContent = s.session_id;

        // Render chosen events' name and issue
        if (Array.isArray(s.events_meta) && s.events_meta.length) {
          let html = '<h3>選定イベント一覧</h3>';
          html += '<table border="1" cellspacing="0" cellpadding="4"><tr>' +
                  '<th>予算事業ID</th><th>事業名</th><th>現状・課題</th></tr>';
          for (const r of s.events_meta) {
            html += `<tr><td>${(r['予算事業ID'] ?? '')}</td>` +
                    `<td>${(r['事業名'] ?? '')}</td>` +
                    `<td>${(r['現状・課題'] ?? '')}</td></tr>`;
          }
          html += '</table>';
          metaOut.innerHTML = html;
        }
      } catch (e) {
        out.textContent = `error: ${e.status}\n` + JSON.stringify(e.data, null, 2);
      }
    }

    async function nextEvent() {
      const sid = document.getElementById('session_id').textContent.trim();
      const out = document.getElementById('event');
      if (!sid) { alert('先にセッションを開始してください'); return; }
      out.textContent = 'loading next event...';
      try {
        const url = `/v1/events/next?session_id=${encodeURIComponent(sid)}`;
        const ev = await api(url);
        out.textContent = JSON.stringify(ev, null, 2);
      } catch (e) {
        out.textContent = `error: ${e.status}\n` + JSON.stringify(e.data, null, 2);
      }
    }

    async function loadOverview() {
      const box = document.getElementById('overview_content');
      box.innerHTML = 'loading...';
      try {
        const m = await api('/v1/events/overview');
        let html = '';
        html += `<div class="headline">${m['事業名'] ?? ''}</div>`;
        html += `<div><h3>課題（現状・課題）</h3><div class="code">${(m['現状・課題'] ?? m['genjo_kadai'] ?? '').replace(/\n/g,'<br>')}</div></div>`;
        box.innerHTML = html;
      } catch (e) {
        box.innerHTML = `error: ${e.status}<br><pre class="code">${JSON.stringify(e.data, null, 2)}</pre>`;
      }
    }
    // ---- Overview schedule (random, no-repeat, 60 months) ----
    const S_KEY = 'pg_overview_schedule_v1';
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }
    async function initSchedule(){
      let state = null;
      try{ state = JSON.parse(localStorage.getItem(S_KEY) || 'null'); }catch{}
      if(state && Array.isArray(state.ids) && typeof state.idx==='number'){
        return state;
      }
      const ids = await api('/v1/events/ids');
      const ids60 = ids.slice(0, 60);
      shuffle(ids60);
      state = { ids: ids60, idx: 0 };
      localStorage.setItem(S_KEY, JSON.stringify(state));
      return state;
    }
    function saveSchedule(state){ localStorage.setItem(S_KEY, JSON.stringify(state)); }
    function idxToPeriod(idx){
      const year = Math.floor(idx/12) + 1;
      const month = (idx % 12) + 1;
      return {year, month};
    }
    async function renderOverview(state){
      const box = document.getElementById('overview_content');
      const btn = document.getElementById('btn_next_overview');
      const label = document.getElementById('period_label');
      const total = state.ids.length;
      if(state.idx >= total){
        btn.disabled = true;
        label.textContent = 'ゲーム終了';
        box.innerHTML = '<div class="muted">全てのイベントを表示しました</div>';
        return;
      }
      const {year, month} = idxToPeriod(state.idx);
      label.textContent = `${year}年目 ${month}月`;
      box.innerHTML = 'loading...';
      try{
        const id = state.ids[state.idx];
        const m = await api(`/v1/events/meta?budget_id=${encodeURIComponent(id)}`);
        const kadai = (m['現状・課題'] ?? m['genjo_kadai'] ?? '')
        let html = '';
        html += `<div class="headline">${m['事業名'] ?? m['jigyo_mei'] ?? ''}</div>`;
        html += `<div><h3>課題（現状・課題）</h3><div class="code">${kadai.replace(/\n/g,'<br>')}</div></div>`;
        box.innerHTML = html;
        box.dataset.kadai = kadai;
        box.dataset.gaiyo = '';
      }catch(e){
        box.innerHTML = `error: ${e.status}<br><pre class="code">${JSON.stringify(e.data, null, 2)}</pre>`;
      }
    }
    async function loadOverview(){
      // no-op on load; use server-driven flow via startGame/nextEventServer
      const box = document.getElementById('overview_content');
      box.innerHTML = '<span class="muted">ヘッダーの「ゲーム開始」→「今月の事業を取得」を使ってください</span>';
    }
    async function nextOverview(){ /* deprecated */ }

    async function startGame(){
      try {
        const s = await api('/v1/state/start', { method: 'POST' });
        window.SESSION_ID = s.session_id;
        document.getElementById('kpi_year').textContent = `Year ${s.year}`;
        document.getElementById('kpi_remaining').textContent = `${yen(s.year_budget_remaining)} 円`;
        document.getElementById('period_label').textContent = `${s.year}年目 1月`;
        document.getElementById('overview_content').innerHTML = '<span class="muted">今月の事業を取得を押してください</span>';
        // reset gating for actual view
        window.CURRENT_EVENT_ID = null;
        window.ALLOCATED_EVENT_ID = null;
        const actualBox = document.getElementById('actual_month_box');
        if (actualBox) actualBox.textContent = '';
      } catch (e) {
        alert('ゲーム開始に失敗しました');
      }
    }

    async function refreshMe(){
      if (!window.SESSION_ID) return;
      try {
        const m = await api(`/v1/state/me?session_id=${encodeURIComponent(window.SESSION_ID)}`);
        document.getElementById('kpi_year').textContent = `Year ${m.year}`;
        document.getElementById('kpi_remaining').textContent = `${yen(m.year_budget_remaining)} 円`;
      } catch {}
    }

    async function nextEventServer(){
      if (!window.SESSION_ID) { alert('先にゲーム開始を押してください'); return; }
      const box = document.getElementById('overview_content');
      box.innerHTML = 'loading...';
      try {
        const ev = await api(`/v1/events/next?session_id=${encodeURIComponent(window.SESSION_ID)}`);
        const meta = ev.meta || {};
        window.CURRENT_EVENT_ID = ev['予算事業ID'];
        window.ALLOCATED_EVENT_ID = null;
        const actualBox = document.getElementById('actual_month_box');
        if (actualBox) actualBox.textContent = '';
        document.getElementById('period_label').textContent = `${ev.year}年目 ${ev.month_in_year}月`;
        let html = '';
        html += `<div class="headline">${meta['事業名'] ?? ''}</div>`;
        const kadai = (meta['現状・課題'] ?? '').replace(/\n/g,'<br>');
        html += `<div><h3>課題（現状・課題）</h3><div class="code">${kadai}</div></div>`;
        box.innerHTML = html;
      } catch (e) {
        if (e && e.status === 409) {
          // 年度終了。次年度へ進む導線を表示
          box.innerHTML = '<div class="muted">この年度のイベントは終了しました。</div>' +
            '<div class="actions" style="margin-top:8px">' +
            '<button class="btn btn-secondary" onclick="goNextYear()">次年度へ進む</button>' +
            '</div>';
        } else {
          box.innerHTML = `error: ${e.status || ''}`;
        }
      }
    }

    async function goNextYear(){
      if (!window.SESSION_ID) { alert('先にゲーム開始を押してください'); return; }
      try {
        const res = await api('/v1/state/next_year', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: window.SESSION_ID })
        });
        // KPI更新
        document.getElementById('kpi_year').textContent = `Year ${res.moved_to_year}`;
        document.getElementById('kpi_remaining').textContent = `${yen(res.year_budget_remaining)} 円`;
        // 表示を初期化して新年度1月のイベント取得
        const box = document.getElementById('overview_content');
        box.innerHTML = '<span class="muted">新年度のイベントを取得しています...</span>';
        // 1月のイベントを取得
        await nextEventServer();
      } catch (e) {
        alert('次年度への遷移に失敗しました');
      }
    }

    async function allocateBudget(){
      if (!window.SESSION_ID || !window.CURRENT_EVENT_ID) { alert('イベントを取得してください'); return; }
      const amt = parseFloat(document.getElementById('alloc_input')?.value || '0');
      if (!(amt > 0)) { alert('割当額を入力してください'); return; }
      try {
        const res = await api('/v1/allocate', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: window.SESSION_ID, event_id: String(window.CURRENT_EVENT_ID), allocated_budget: amt })
        });
        document.getElementById('kpi_remaining').textContent = `${yen(res.year_budget_remaining)} 円`;
        window.ALLOCATED_EVENT_ID = window.CURRENT_EVENT_ID;
        alert('割当を保存しました');
      } catch (e) {
        alert('割当に失敗しました: ' + (e.data?.detail || ''));
      }
    }

    async function openProjectDetail(budgetId){
      const modal = document.getElementById('detail_modal');
      const body = document.getElementById('detail_body');
      const title = document.getElementById('detail_title');
      body.innerHTML = 'loading...';
      let m = null;
      try {
        if (budgetId) {
          m = await api(`/v1/events/meta?budget_id=${encodeURIComponent(budgetId)}`);
        } else {
          throw new Error('no id');
        }
      } catch (e) {}
      try {
        if (!m) throw new Error('not found');
        title.textContent = m['事業名'] ?? m['jigyo_mei'] ?? '詳細';
        const gaiyo = (m['事業の概要'] ?? m['jigyo_no_gaiyo'] ?? '');
        const mokuteki = (m['現状・課題'] ?? m['genjo_kadai'] ?? '');
        const url = (m['事業概要URL'] ?? '');
        let html = '';
        html += `<div class="detail-row"><strong>目的/課題</strong><p>${(mokuteki||'').replace(/\n/g,'<br>')}</p></div>`;
        html += `<div class="detail-row"><strong>事業の概要</strong><p>${(gaiyo||'').replace(/\n/g,'<br>')}</p></div>`;
        if (url) html += `<div class="detail-row"><strong>参考URL</strong><p><a href="${url}" target="_blank" rel="noopener">${url}</a></p></div>`;
        body.innerHTML = html;
        modal.classList.add('show');
      } catch (e) {
        body.innerHTML = '取得に失敗しました';
        modal.classList.add('show');
      }
    }

    function closeDetail(){
      const modal = document.getElementById('detail_modal');
      if (modal) modal.classList.remove('show');
    }

    function predictFromInputs(){
      const g = (document.getElementById('input_gaiyo')?.value || '').trim();
      const text = g;
      const q = document.getElementById('query_text');
      if (q) q.value = text;
      predictText();
    }

    async function showActualThisMonth(){
      const box = document.getElementById('actual_month_box');
      if (!box) return;
      if (!window.CURRENT_EVENT_ID || window.ALLOCATED_EVENT_ID !== window.CURRENT_EVENT_ID) {
        alert('今は見ることができません（この月の事業に予算を割り当ててください）');
        return;
      }
      box.textContent = 'loading actual...';
      try{
        const curId = String(window.CURRENT_EVENT_ID);
        const meta = await api(`/v1/events/meta?budget_id=${encodeURIComponent(curId)}`);
        const actualInit = meta['当初予算'] ?? meta['tosho_yosan'];
        const actualName = meta['事業名'] ?? meta['jigyo_mei'] ?? '';
        box.innerHTML = `
<section class="summary-kpi-section">
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">📌</div>
      <div class="kpi-content">
        <h3>今月の当初予算</h3>
        <div class="kpi-value">${yen(actualInit)} 円</div>
      </div>
    </div>
  </div>
</section>
<div class="muted">事業名: ${actualName}</div>`;
      }catch(e){
        box.textContent = '取得に失敗しました';
      }
    }

    async function resetOverview(){
      try { localStorage.removeItem(S_KEY); } catch {}
      await loadOverview();
      // Re-enable next button just in case
      const btn = document.getElementById('btn_next_overview');
      if (btn) btn.disabled = false;
    }
  </script>
</head>
<body onload="loadOverview()">
  <header class="header">
    <div class="header-content">
      <div class="app-title">Policy Game</div>
      <div class="header-actions">
        <button class="btn btn-outline" onclick="startGame()">ゲーム開始</button>
        <button class="btn btn-outline" onclick="nextEventServer()">今月の事業を取得</button>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="two-column-layout">
      <section id="leftpane" class="card">
        <div class="card-title">今月の事業</div>
        <div class="actions">
          <span class="muted" id="period_label"></span>
        </div>
        <div id="overview_content" class="result"></div>
        <div class="card-title" style="margin-top:14px">入力</div>
        <div class="project-form">
          <div class="form-group">
            <label for="input_gaiyo">事業の概要</label>
            <textarea id="input_gaiyo" rows="6" placeholder="事業の概要を入力"></textarea>
          </div>
          <div class="form-group">
            <label for="alloc_input">この事業への割当額（円）</label>
            <input type="number" id="alloc_input" placeholder="例: 5000000000" />
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" onclick="predictFromInputs()">この内容で予測</button>
            <button class="btn btn-secondary" onclick="allocateBudget()">この事業に割当</button>
          </div>
        </div>
        <input type="hidden" id="query_text" />
      </section>
      <section id="rightpane" class="card">
        <div class="card-title">予算推定・類似事業</div>
        <section class="summary-kpi-section">
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-icon">📅</div>
              <div class="kpi-content">
                <h3>年度</h3>
                <div class="kpi-value" id="kpi_year">-</div>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon">💵</div>
              <div class="kpi-content">
                <h3>年度残額</h3>
                <div class="kpi-value" id="kpi_remaining">- 円</div>
              </div>
            </div>
          </div>
        </section>
        <div class="actions" style="margin:8px 0">
          <button class="btn small" id="btn_show_actual" onclick="showActualThisMonth()">今月の事業の当初予算を確認</button>
          <span id="actual_month_box" class="muted" style="margin-left:8px"></span>
        </div>
        <div id="pred" class="projects-list"></div>
      </section>
    </div>

    <!-- 詳細モーダル -->
    <div id="detail_modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="detail_title">詳細</h3>
          <button class="modal-close" onclick="closeDetail()">×</button>
        </div>
        <div class="modal-body" id="detail_body"></div>
      </div>
    </div>

    
  </main>

  <footer class="site-footer">
    <div class="container">
      <span class="muted">© Policy Game Demo</span>
    </div>
  </footer>
</body>
</html>
