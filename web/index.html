<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Policy Game | äºˆç®—æ¨å®šãƒ‡ãƒ¢</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="app-light.css" />
  <script>
    const api = (path, init) => fetch(path, init).then(async r => {
      const text = await r.text();
      let data; try { data = JSON.parse(text); } catch { data = text; }
      if (!r.ok) {
        throw { status: r.status, data };
      }
      return data;
    });

    async function loadInfo() {
      const out = document.getElementById('info');
      out.textContent = 'loading...';
      try {
        const info = await api('/v1/budget/model_info');
        out.textContent = JSON.stringify(info, null, 2);
        const dim = info.x_dim;
        document.getElementById('dim').textContent = `x_dim=${dim}, items=${info.n_items}`;
      } catch (e) {
        out.textContent = `error: ${e.status} \n` + JSON.stringify(e.data, null, 2);
      }
    }

    function yen(n) {
      if (n === null || n === undefined || isNaN(n)) return '';
      try {
        const v = Math.round(Number(n));
        return v.toLocaleString('ja-JP');
      } catch {
        return String(n);
      }
    }

    async function predictText() {
      const hidden = document.getElementById('query_text');
      const fromHidden = hidden ? (hidden.value || '') : '';
      const fromInput = (document.getElementById('input_gaiyo')?.value || '');
      const t = (fromHidden || fromInput || '').trim();
      const out = document.getElementById('pred');
      out.textContent = 'predicting (text)...';
      if (!t) {
        out.textContent = 'å…¥åŠ›ãŒç©ºã§ã™ã€‚äº‹æ¥­ã®æ¦‚è¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      try {
        const res = await api('/v1/budget/predict', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query_text: t })
        });
        // Render pretty output (æ¨å®šå½“åˆäºˆç®—ã®ã¿)
        let html = '';
        html += `
<section class="summary-kpi-section">
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ’°</div>
      <div class="kpi-content">
        <h3>æ¨å®šå½“åˆäºˆç®—</h3>
        <div class="kpi-value">${yen(res.estimate_initial)} å††</div>
      </div>
    </div>
  </div>
</section>`;
        // å®Ÿãƒ‡ãƒ¼ã‚¿ç¢ºèªãƒœã‚¿ãƒ³ã¯å³ãƒšã‚¤ãƒ³ã®å›ºå®šãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ï¼ˆã“ã“ã§ã¯è¿½åŠ ã—ãªã„ï¼‰
        
        html += '<br/>';
        html += '<div class="card-title" style="margin-top:8px">é¡ä¼¼äº‹æ¥­</div>';
        if (Array.isArray(res.topk) && res.topk.length) {
          html += '<div class="projects-list">';
          for (const r of res.topk) {
            const sim = Number(r.similarity ?? 0);
            const sim01 = Math.max(0, Math.min(1, (sim + 1) / 2));
            const simPct = (sim01*100).toFixed(0);
            const name = (r.name ?? '');
            html += `
              <div class=\"project-item${r.rank===1 ? ' top1' : ''}">
                <div class="project-header">
                  <span class="rank-badge">#${r.rank}</span>
                  <span class="project-name">${name}</span>
                </div>
                <div class="simbar"><div class="simbar-fill" style="width:${simPct}%"></div></div>
                <div class="project-rating">
                  <span class="sim">sim ${(sim).toFixed(3)} (${simPct}%)</span>
                  <span class="y0">å½“åˆ ${yen(r.initial_budget)}</span>
                </div>
              </div>`;
          }
          html += '</div>';
        } else {
          html += '<div class="muted">é¡ä¼¼äº‹æ¥­ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        }
        out.innerHTML = html;
        // Attach click handlers to similar project cards
        try {
          window.LAST_PRED = res;
          const cards = out.querySelectorAll('.project-item');
          cards.forEach((el, i) => {
            const bid = (res.topk && res.topk[i] && res.topk[i].budget_id) ? String(res.topk[i].budget_id) : '';
            el.dataset.bid = bid;
            if (bid) {
              el.style.cursor = 'pointer';
              el.addEventListener('click', () => openProjectDetail(el.dataset.bid));
            } else {
              el.title = 'IDãŒç„¡ã„ãŸã‚è©³ç´°ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“';
            }
          });
        } catch {}
      } catch (e) {
        out.textContent = `error: ${e.status} \n` + JSON.stringify(e.data, null, 2);
      }
    }

    async function startSession() {
      const out = document.getElementById('session');
      const metaOut = document.getElementById('start_events_meta');
      out.textContent = 'starting...';
      metaOut.innerHTML = '';
      try {
        const idsRaw = document.getElementById('event_ids_input').value.trim();
        let body = undefined;
        if (idsRaw) {
          const ids = idsRaw.split(',').map(s=>s.trim()).filter(Boolean);
          body = JSON.stringify({ event_ids: ids });
        }
        const s = await api('/v1/state/start', {
          method: 'POST', headers: body? { 'Content-Type': 'application/json' } : undefined, body
        });
        out.textContent = JSON.stringify(s, null, 2);
        document.getElementById('session_id').textContent = s.session_id;

        // Render chosen events' name and issue
        if (Array.isArray(s.events_meta) && s.events_meta.length) {
          let html = '<h3>é¸å®šã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h3>';
          html += '<table border="1" cellspacing="0" cellpadding="4"><tr>' +
                  '<th>äºˆç®—äº‹æ¥­ID</th><th>äº‹æ¥­å</th><th>ç¾çŠ¶ãƒ»èª²é¡Œ</th></tr>';
          for (const r of s.events_meta) {
            html += `<tr><td>${(r['äºˆç®—äº‹æ¥­ID'] ?? '')}</td>` +
                    `<td>${(r['äº‹æ¥­å'] ?? '')}</td>` +
                    `<td>${(r['ç¾çŠ¶ãƒ»èª²é¡Œ'] ?? '')}</td></tr>`;
          }
          html += '</table>';
          metaOut.innerHTML = html;
        }
      } catch (e) {
        out.textContent = `error: ${e.status}\n` + JSON.stringify(e.data, null, 2);
      }
    }

    async function nextEvent() {
      const sid = document.getElementById('session_id').textContent.trim();
      const out = document.getElementById('event');
      if (!sid) { alert('å…ˆã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„'); return; }
      out.textContent = 'loading next event...';
      try {
        const url = `/v1/events/next?session_id=${encodeURIComponent(sid)}`;
        const ev = await api(url);
        out.textContent = JSON.stringify(ev, null, 2);
      } catch (e) {
        out.textContent = `error: ${e.status}\n` + JSON.stringify(e.data, null, 2);
      }
    }

    async function loadOverview() {
      const box = document.getElementById('overview_content');
      box.innerHTML = 'loading...';
      try {
        const m = await api('/v1/events/overview');
        let html = '';
        html += `<div class="headline">${m['äº‹æ¥­å'] ?? ''}</div>`;
        html += `<div><h3>èª²é¡Œï¼ˆç¾çŠ¶ãƒ»èª²é¡Œï¼‰</h3><div class="code">${(m['ç¾çŠ¶ãƒ»èª²é¡Œ'] ?? m['genjo_kadai'] ?? '').replace(/\n/g,'<br>')}</div></div>`;
        box.innerHTML = html;
      } catch (e) {
        box.innerHTML = `error: ${e.status}<br><pre class="code">${JSON.stringify(e.data, null, 2)}</pre>`;
      }
    }
    // ---- Overview schedule (random, no-repeat, 60 months) ----
    const S_KEY = 'pg_overview_schedule_v1';
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }
    async function initSchedule(){
      let state = null;
      try{ state = JSON.parse(localStorage.getItem(S_KEY) || 'null'); }catch{}
      if(state && Array.isArray(state.ids) && typeof state.idx==='number'){
        return state;
      }
      const ids = await api('/v1/events/ids');
      const ids60 = ids.slice(0, 60);
      shuffle(ids60);
      state = { ids: ids60, idx: 0 };
      localStorage.setItem(S_KEY, JSON.stringify(state));
      return state;
    }
    function saveSchedule(state){ localStorage.setItem(S_KEY, JSON.stringify(state)); }
    function idxToPeriod(idx){
      const year = Math.floor(idx/12) + 1;
      const month = (idx % 12) + 1;
      return {year, month};
    }
    async function renderOverview(state){
      const box = document.getElementById('overview_content');
      const btn = document.getElementById('btn_next_overview');
      const label = document.getElementById('period_label');
      const total = state.ids.length;
      if(state.idx >= total){
        btn.disabled = true;
        label.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
        box.innerHTML = '<div class="muted">å…¨ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ</div>';
        return;
      }
      const {year, month} = idxToPeriod(state.idx);
      label.textContent = `${year}å¹´ç›® ${month}æœˆ`;
      box.innerHTML = 'loading...';
      try{
        const id = state.ids[state.idx];
        const m = await api(`/v1/events/meta?budget_id=${encodeURIComponent(id)}`);
        const kadai = (m['ç¾çŠ¶ãƒ»èª²é¡Œ'] ?? m['genjo_kadai'] ?? '')
        let html = '';
        html += `<div class="headline">${m['äº‹æ¥­å'] ?? m['jigyo_mei'] ?? ''}</div>`;
        html += `<div><h3>èª²é¡Œï¼ˆç¾çŠ¶ãƒ»èª²é¡Œï¼‰</h3><div class="code">${kadai.replace(/\n/g,'<br>')}</div></div>`;
        box.innerHTML = html;
        box.dataset.kadai = kadai;
        box.dataset.gaiyo = '';
      }catch(e){
        box.innerHTML = `error: ${e.status}<br><pre class="code">${JSON.stringify(e.data, null, 2)}</pre>`;
      }
    }
    async function loadOverview(){
      // no-op on load; use server-driven flow via startGame/nextEventServer
      const box = document.getElementById('overview_content');
      box.innerHTML = '<span class="muted">ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€â†’ã€Œä»Šæœˆã®äº‹æ¥­ã‚’å–å¾—ã€ã‚’ä½¿ã£ã¦ãã ã•ã„</span>';
    }
    async function nextOverview(){ /* deprecated */ }

    async function startGame(){
      try {
        const s = await api('/v1/state/start', { method: 'POST' });
        window.SESSION_ID = s.session_id;
        document.getElementById('kpi_year').textContent = `Year ${s.year}`;
        document.getElementById('kpi_remaining').textContent = `${yen(s.year_budget_remaining)} å††`;
        document.getElementById('period_label').textContent = `${s.year}å¹´ç›® 1æœˆ`;
        document.getElementById('overview_content').innerHTML = '<span class="muted">ä»Šæœˆã®äº‹æ¥­ã‚’å–å¾—ã‚’æŠ¼ã—ã¦ãã ã•ã„</span>';
        // reset gating for actual view
        window.CURRENT_EVENT_ID = null;
        window.ALLOCATED_EVENT_ID = null;
        const actualBox = document.getElementById('actual_month_box');
        if (actualBox) actualBox.textContent = '';
        resetLineSeries();
        try { setNextButtonEnabled(false); } catch {}
        try { await nextEventServer(); } catch {}
        try { await loadMetrics(); } catch {}
      } catch (e) {
        alert('ã‚²ãƒ¼ãƒ é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function refreshMe(){
      if (!window.SESSION_ID) return;
      try {
        const m = await api(`/v1/state/me?session_id=${encodeURIComponent(window.SESSION_ID)}`);
        document.getElementById('kpi_year').textContent = `Year ${m.year}`;
        document.getElementById('kpi_remaining').textContent = `${yen(m.year_budget_remaining)} å††`;
      } catch {}
    }

    async function nextEventServer(){
      if (!window.SESSION_ID) { alert('å…ˆã«ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
      const box = document.getElementById('overview_content');
      box.innerHTML = 'loading...';
      try {
        const ev = await api(`/v1/events/next?session_id=${encodeURIComponent(window.SESSION_ID)}`);
        const meta = ev.meta || {};
        window.CURRENT_EVENT_ID = ev['äºˆç®—äº‹æ¥­ID'];
        window.CURRENT_MONTH = ev.month_in_year;
        window.CURRENT_NAME = meta['äº‹æ¥­å'] || '';
        window.ALLOCATED_EVENT_ID = null;
        const actualBox = document.getElementById('actual_month_box');
        if (actualBox) actualBox.textContent = '';
        document.getElementById('period_label').textContent = `${ev.year}å¹´ç›® ${ev.month_in_year}æœˆ`;
        let html = '';
        html += `<div class="headline">${meta['äº‹æ¥­å'] ?? ''}</div>`;
        const kadai = (meta['ç¾çŠ¶ãƒ»èª²é¡Œ'] ?? '').replace(/\n/g,'<br>');
        html += `<div><h3>èª²é¡Œï¼ˆç¾çŠ¶ãƒ»èª²é¡Œï¼‰</h3><div class="code">${kadai}</div></div>`;
        box.innerHTML = html;
        try { setNextButtonEnabled(false); } catch {}
        try { await loadMetrics(); } catch {}
      } catch (e) {
        if (e && e.status === 409) {
          // å¹´åº¦çµ‚äº†ã€‚æ¬¡å¹´åº¦ã¸é€²ã‚€å°ç·šã‚’è¡¨ç¤º
          box.innerHTML = '<div class="muted">ã“ã®å¹´åº¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯çµ‚äº†ã—ã¾ã—ãŸã€‚</div>' +
            '<div class="actions" style="margin-top:8px">' +
            '<button class="btn btn-secondary" onclick="goNextYear()">æ¬¡å¹´åº¦ã¸é€²ã‚€</button>' +
            '</div>';
        } else {
          box.innerHTML = `error: ${e.status || ''}`;
        }
      }
    }

    // å…¥åŠ›å€¤ã‚’â€œãƒ¦ãƒ¼ã‚¶æƒ³å®šäºˆç®—â€ã¨ã—ã¦æŠ˜ã‚Œç·šã«è¿½åŠ ï¼ˆå®Ÿäºˆç®—ã¯è¡¨ç¤ºã—ãªã„ï¼‰
    function setNextButtonEnabled(enabled){
      const b = document.getElementById('btn_next_month');
      const hint = document.getElementById('next_hint');
      if (b){
        b.disabled = !enabled;
        b.setAttribute('aria-disabled', String(!enabled));
        if (!enabled){
          b.title = 'ã“ã®æœˆã®äº‹æ¥­ã«å‰²å½“ã‚’è¡Œã†ã¨æ¬¡ã¸é€²ã‚ã¾ã™';
        } else {
          b.title = 'æ¬¡ã®æœˆã¸é€²ã‚ã¾ã™';
        }
      }
      if (hint){
        if (enabled){
          hint.textContent = 'æ¬¡ã®æœˆã¸é€²ã‚ã¾ã™';
          hint.classList.add('ok');
        } else {
          hint.textContent = 'ã“ã®æœˆã®äº‹æ¥­ã«å‰²å½“ã‚’è¡Œã†ã¨æ¬¡ã¸é€²ã‚ã¾ã™';
          hint.classList.remove('ok');
        }
      }
    }

    function getCurrentInputAmount(){
      const raw = document.getElementById('alloc_input')?.value || '';
      const v = parseFloat(raw);
      return (v > 0) ? v : null;
    }

    async function nextMonth(){
      if (!window.SESSION_ID) { alert('å…ˆã«ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
      if (!window.CURRENT_EVENT_ID) { alert('ä»Šæœˆã®äº‹æ¥­ã‚’å–å¾—ã—ã¦ãã ã•ã„'); return; }
      if (window.ALLOCATED_EVENT_ID !== window.CURRENT_EVENT_ID) {
        alert('ã“ã®æœˆã®äº‹æ¥­ã«å‰²å½“ã‚’è¡Œã£ã¦ã‹ã‚‰æ¬¡ã®æœˆã¸é€²ã‚“ã§ãã ã•ã„');
        return;
      }
      // ç¾åœ¨æœˆã®æƒ³å®šå€¤ï¼ˆå…¥åŠ›ãŒã‚ã‚Œã°ï¼‰ã¨å®Ÿï¼ˆå‰²å½“å¾Œãªã®ã§å…¬é–‹OKï¼‰ã‚’æœ€çµ‚åæ˜ ã—ã¦ã‹ã‚‰æ¬¡ã¸
      try {
        const userAmt = getCurrentInputAmount();
        const sid = window.SESSION_ID;
        const curId = String(window.CURRENT_EVENT_ID || '');
        const curMonth = window.CURRENT_MONTH;
        const name = window.CURRENT_NAME || '';
        if (sid && curId && curMonth){
          const data = await api(`/v1/metrics/months?session_id=${encodeURIComponent(sid)}`);
          const months = Array.isArray(data.months) ? data.months : [];
          const rec = months.find(m => String(m.event_id||'') === curId);
          const actual = (rec && rec.actual_initial!=null) ? rec.actual_initial : null;
          if (userAmt!=null || actual!=null) appendLinePoint(curMonth, userAmt, actual, name);
        }
      } catch {}
      await nextEventServer();
      // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã€æ¬¡æœˆã¯æœªå‰²å½“ãªã®ã§ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      try { document.getElementById('alloc_input').value = ''; } catch {}
      try { document.getElementById('input_gaiyo').value = ''; } catch {}
      setNextButtonEnabled(false);
    }

    async function goNextYear(){
      if (!window.SESSION_ID) { alert('å…ˆã«ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return; }
      try {
        // å¹´åº¦çµ‚äº†å‰ã«ã€å½“è©²æœˆã®å…¥åŠ›å€¤ã‚’åæ˜ ï¼ˆç‚¹è¿½åŠ ï¼‰
        try { addUserPointForCurrentMonth(); } catch {}
        const res = await api('/v1/state/next_year', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: window.SESSION_ID })
        });
        // KPIæ›´æ–°
        document.getElementById('kpi_year').textContent = `Year ${res.moved_to_year}`;
        document.getElementById('kpi_remaining').textContent = `${yen(res.year_budget_remaining)} å††`;
        // è¡¨ç¤ºã‚’åˆæœŸåŒ–ã—ã¦æ–°å¹´åº¦1æœˆã®ã‚¤ãƒ™ãƒ³ãƒˆå–å¾—
        const box = document.getElementById('overview_content');
        box.innerHTML = '<span class="muted">æ–°å¹´åº¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã¦ã„ã¾ã™...</span>';
        // 1æœˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
        await nextEventServer();
        resetLineSeries();
        try { await loadMetrics(); } catch {}
      } catch (e) {
        alert('æ¬¡å¹´åº¦ã¸ã®é·ç§»ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function allocateBudget(){
      if (!window.SESSION_ID || !window.CURRENT_EVENT_ID) { alert('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ã—ã¦ãã ã•ã„'); return; }
      const amt = parseFloat(document.getElementById('alloc_input')?.value || '0');
      if (!(amt > 0)) { alert('å‰²å½“é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      try {
        const res = await api('/v1/allocate', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: window.SESSION_ID, event_id: String(window.CURRENT_EVENT_ID), allocated_budget: amt })
        });
        document.getElementById('kpi_remaining').textContent = `${yen(res.year_budget_remaining)} å††`;
        window.ALLOCATED_EVENT_ID = window.CURRENT_EVENT_ID;
        alert('å‰²å½“ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        try { setNextButtonEnabled(true); } catch {}
        // ç›´è¿‘ã®ã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾å¿œã™ã‚‹æœˆãƒ»å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦æŠ˜ã‚Œç·šã«è¿½åŠ 
        try {
          const data = await api(`/v1/metrics/months?session_id=${encodeURIComponent(window.SESSION_ID)}`);
          const months = Array.isArray(data.months) ? data.months : [];
          const rec = months.find(m => String(m.event_id||'') === String(window.CURRENT_EVENT_ID||''));
          if (rec) {
            // å®Ÿäºˆç®—ã¯å‰²å½“ãŒå…¥ã£ãŸæœˆã®ã¿è¡¨ç¤º
            appendLinePoint(rec.month, amt, (rec.actual_initial!=null? rec.actual_initial : null), rec.name || '');
          }
        } catch {}
        try { await loadMetrics(); } catch {}
      } catch (e) {
        alert('å‰²å½“ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.data?.detail || ''));
      }
    }

    async function openProjectDetail(budgetId){
      const modal = document.getElementById('detail_modal');
      const body = document.getElementById('detail_body');
      const title = document.getElementById('detail_title');
      body.innerHTML = 'loading...';
      let m = null;
      try {
        if (budgetId) {
          m = await api(`/v1/events/meta?budget_id=${encodeURIComponent(budgetId)}`);
        } else {
          throw new Error('no id');
        }
      } catch (e) {}
      try {
        if (!m) throw new Error('not found');
        title.textContent = m['äº‹æ¥­å'] ?? m['jigyo_mei'] ?? 'è©³ç´°';
        const gaiyo = (m['äº‹æ¥­ã®æ¦‚è¦'] ?? m['jigyo_no_gaiyo'] ?? '');
        const mokuteki = (m['ç¾çŠ¶ãƒ»èª²é¡Œ'] ?? m['genjo_kadai'] ?? '');
        const url = (m['äº‹æ¥­æ¦‚è¦URL'] ?? '');
        let html = '';
        html += `<div class="detail-row"><strong>ç›®çš„/èª²é¡Œ</strong><p>${(mokuteki||'').replace(/\n/g,'<br>')}</p></div>`;
        html += `<div class="detail-row"><strong>äº‹æ¥­ã®æ¦‚è¦</strong><p>${(gaiyo||'').replace(/\n/g,'<br>')}</p></div>`;
        if (url) html += `<div class="detail-row"><strong>å‚è€ƒURL</strong><p><a href="${url}" target="_blank" rel="noopener">${url}</a></p></div>`;
        body.innerHTML = html;
        modal.classList.add('show');
      } catch (e) {
        body.innerHTML = 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
        modal.classList.add('show');
      }
    }

    function closeDetail(){
      const modal = document.getElementById('detail_modal');
      if (modal) modal.classList.remove('show');
    }

    function predictFromInputs(){
      const g = (document.getElementById('input_gaiyo')?.value || '').trim();
      const text = g;
      const q = document.getElementById('query_text');
      if (q) q.value = text;
      predictText();
    }

    // ---- Examples Assist ----
    const EXAMPLES = [
      { title: 'æ•™è‚²ICTåŒ–', text: 'å°ä¸­å­¦æ ¡ã§ã®1äºº1å°ç«¯æœ«æ´»ç”¨ãŒé€²ã¾ãšå­¦ç¿’æ ¼å·®ãŒç”Ÿã˜ã¦ã„ã‚‹ã€‚æ•™å“¡ç ”ä¿®ã€æ ¡å†…Wiâ€‘Fiæ•´å‚™ã€ç«¯æœ«æ›´æ–°ã‚’ä¸€ä½“ã§å®Ÿæ–½ã—ã€ãƒ‡ã‚¸ã‚¿ãƒ«æ•™æã®æ´»ç”¨ç‡ã‚’é«˜ã‚ã‚‹ã€‚åˆ°é”åº¦ãƒ†ã‚¹ãƒˆã§å­¦åŠ›æŒ‡æ¨™ã®å‘ä¸Šã‚’å›³ã‚‹ã€‚' },
      { title: 'é˜²ç½ãƒ»æ²³å·æ²»æ°´', text: 'é›†ä¸­è±ªé›¨ã«ã‚ˆã‚Šæµ¸æ°´è¢«å®³ãŒå¤šç™ºã€‚ä¸­å°æ²³å·ã®å ¤é˜²å¼·åŒ–ã¨æ’æ°´æ©Ÿå ´ã®æ›´æ–°ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ°´ä½ç›£è¦–ã‚’å°å…¥ã™ã‚‹ã€‚é¿é›£åˆ¤æ–­æ™‚é–“ã®çŸ­ç¸®ã¨æµ¸æ°´é¢ç©ã®ç¸®å°ã‚’ç›®æŒ‡ã™ã€‚' },
      { title: 'å­è‚²ã¦æ”¯æ´ãƒ»ä¿è‚²å£«ç¢ºä¿', text: 'ä¿è‚²å£«ä¸è¶³ã§å¾…æ©Ÿå…ç«¥ãŒç™ºç”Ÿã€‚å‡¦é‡æ”¹å–„åŠ ç®—ã®æ‹¡å……ã¨å°±è·æº–å‚™é‡‘ã®æ”¯çµ¦ã€æ½œåœ¨ä¿è‚²å£«ã®å¾©è·æ”¯æ´ã‚’è¡Œã†ã€‚å®šå“¡å……è¶³ç‡ã‚’æ”¹å–„ã—å¾…æ©Ÿå…ç«¥ã‚¼ãƒ­ã‚’ç›®æŒ‡ã™ã€‚' },
      { title: 'å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼', text: 'åŒ–çŸ³ç‡ƒæ–™ä¾å­˜ãŒé«˜ãé›»åŠ›æ–™é‡‘ãŒä¸Šæ˜‡ã€‚å…¬å…±æ–½è¨­å±‹æ ¹ã¸ã®å¤ªé™½å…‰ç™ºé›»ã¨è“„é›»æ± ã‚’å°å…¥ã—ã€ç½å®³æ™‚ã®ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ã‚’å¼·åŒ–ã™ã‚‹ã€‚å¹´é–“CO2æ’å‡ºé‡ã®å‰Šæ¸›ã‚’å›³ã‚‹ã€‚' },
      { title: 'è¡Œæ”¿ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–', text: 'çª“å£æ‰‹ç¶šãŒç´™ä¸­å¿ƒã§ä½æ°‘è² æ‹…ãŒå¤§ãã„ã€‚ç”³è«‹ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã¨ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼é€£æºã€RPAå°å…¥ã«ã‚ˆã‚Šå‡¦ç†æ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹ã€‚æ¥åºä»¶æ•°ã¨å‡¦ç†ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã€‚' },
      { title: 'åŒ»ç™‚DXãƒ»é éš”è¨ºç™‚', text: 'éç–åœ°ã§ã®å—è¨ºæ©Ÿä¼šãŒä¸è¶³ã€‚é éš”è¨ºç™‚æ©Ÿå™¨ã¨åœ°åŸŸé€£æºãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æ•´å‚™ã—ã€æ…¢æ€§ç–¾æ‚£ã®ç¶™ç¶šæ²»ç™‚ã‚’æ”¯æ´ã™ã‚‹ã€‚æ•‘æ€¥æ¬é€ä»¶æ•°ã¨é‡ç—‡åŒ–ç‡ã®ä½æ¸›ã‚’å›³ã‚‹ã€‚' },
      { title: 'åœ°åŸŸå…¬å…±äº¤é€š', text: 'èµ¤å­—è·¯ç·šã®å»ƒæ­¢ã§ç§»å‹•æ‰‹æ®µãŒé™ã‚‰ã‚Œã‚‹ã€‚ãƒ‡ãƒãƒ³ãƒ‰å‹äº¤é€šã¨MaaSã‚¢ãƒ—ãƒªã‚’å°å…¥ã—ã€é«˜é½¢è€…ã®é€šé™¢ãƒ»è²·ç‰©ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºä¿ã™ã‚‹ã€‚åˆ©ç”¨è€…æ•°ã¨é‹è¡ŒåŠ¹ç‡ã‚’æ”¹å–„ã€‚' },
      { title: 'ã‚¤ãƒ³ãƒ•ãƒ©è€æœ½åŒ–å¯¾ç­–', text: 'æ©‹æ¢ãƒ»ãƒˆãƒ³ãƒãƒ«ã®è€æœ½åŒ–ãŒé€²è¡Œã€‚é‡ç‚¹è·¯ç·šã‚’å¯¾è±¡ã«ç‚¹æ¤œãƒ»è£œä¿®ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚»ãƒ³ã‚µãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ã€‚é€šè¡Œæ­¢ã‚ç™ºç”Ÿä»¶æ•°ã®å‰Šæ¸›ã‚’ç›®æŒ‡ã™ã€‚' },
      { title: 'ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', text: 'è¡Œæ”¿ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¸ã®æ”»æ’ƒãŒå¢—åŠ ã€‚EDRå°å…¥ã€äººæè‚²æˆã€æ¼”ç¿’ã®å®šæœŸå®Ÿæ–½ã§æ¤œçŸ¥ãƒ»å¯¾å¿œåŠ›ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ™‚é–“ã‚’çŸ­ç¸®ã€‚' },
      { title: 'è¾²æ¥­ã‚¹ãƒãƒ¼ãƒˆåŒ–', text: 'æ‹…ã„æ‰‹ä¸è¶³ã¨ç”Ÿç”£æ€§ä½ä¸‹ãŒèª²é¡Œã€‚ãƒ‰ãƒ­ãƒ¼ãƒ³æ•£å¸ƒã¨ç’°å¢ƒã‚»ãƒ³ã‚µãƒ¼ã€å–¶è¾²ãƒ‡ãƒ¼ã‚¿åŸºç›¤ã‚’å°å…¥ã—çœåŠ›åŒ–ã¨åé‡å®‰å®šã‚’å›³ã‚‹ã€‚ä½œæ¥­æ™‚é–“ã®å‰Šæ¸›ã¨æ­©ç•™ã¾ã‚Šå‘ä¸Šã‚’ç›®æ¨™ã€‚' },
      { title: 'è¦³å…‰æŒ¯èˆˆãƒ»ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰', text: 'ã‚³ãƒ­ãƒŠå¾Œã®éœ€è¦å›å¾©ã‚’å–ã‚Šè¾¼ã¿ãŸã„ã€‚å¤šè¨€èªæ¡ˆå†…ã¨æ±ºæ¸ˆç’°å¢ƒã€åºƒåŸŸå‘¨éŠãƒ‘ã‚¹ã‚’æ•´å‚™ã™ã‚‹ã€‚æ»åœ¨æ—¥æ•°ã¨æ¶ˆè²»å˜ä¾¡ã®å¢—åŠ ã‚’ç›®æŒ‡ã™ã€‚' },
      { title: 'é«˜é½¢è€…è¦‹å®ˆã‚Š', text: 'ç‹¬å±…é«˜é½¢è€…ã®è¦‹å®ˆã‚ŠãŒä¸ååˆ†ã€‚IoTã‚»ãƒ³ã‚µãƒ¼ã¨åœ°åŸŸè¦‹å®ˆã‚Šæ‹ ç‚¹ã‚’æ•´å‚™ã—ã€ç•°å¸¸æ¤œçŸ¥æ™‚ã®é€£çµ¡ä½“åˆ¶ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚è»¢å€’ãƒ»ç†±ä¸­ç—‡ã®é‡ç—‡åŒ–ã‚’é˜²æ­¢ã€‚' },
      { title: 'éƒ½å¸‚ç·‘åœ°ãƒ»æš‘ç†±å¯¾ç­–', text: 'ãƒ’ãƒ¼ãƒˆã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰ãŒæ·±åˆ»ã€‚è¡—è·¯æ¨¹æ¤æ ½ã¨ã‚¯ãƒ¼ãƒ«ãƒšãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã€ãƒŸã‚¹ãƒˆè£…ç½®ã‚’é‡ç‚¹é…ç½®ã™ã‚‹ã€‚ä½“æ„Ÿæ¸©åº¦ã®ä½æ¸›ã¨ç†±ä¸­ç—‡æ•‘æ€¥ä»¶æ•°ã®æŠ‘åˆ¶ã‚’å›³ã‚‹ã€‚' },
      { title: 'å¥³æ€§æ”¯æ´ãƒ»DVé˜²æ­¢', text: 'ç›¸è«‡ä»¶æ•°ãŒå¢—åŠ ã€‚ãƒ¯ãƒ³ã‚¹ãƒˆãƒƒãƒ—æ”¯æ´çª“å£ã®å¢—è¨­ã¨ä¸€æ™‚ä¿è­·æ–½è¨­ã®æ‹¡å……ã€åŠ å®³è€…æ›´ç”Ÿãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿæ–½ã™ã‚‹ã€‚å†è¢«å®³é˜²æ­¢ã¨è‡ªç«‹æ”¯æ´ã‚’å¼·åŒ–ã€‚' },
      { title: 'EVå……é›»ã‚¤ãƒ³ãƒ•ãƒ©', text: 'å……é›»ã‚¹ãƒãƒƒãƒˆä¸è¶³ã§æ™®åŠãŒä¼¸ã³ãªã„ã€‚å¹¹ç·šãƒ»è¦³å…‰åœ°ãƒ»é›†åˆä½å®…ã«æ€¥é€Ÿ/æ™®é€šå……é›»å™¨ã‚’é‡ç‚¹é…ç½®ã—ã€é‹ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã™ã‚‹ã€‚ç¨¼åƒç‡ã¨å°æ•°æ™®åŠã‚’æ”¯æ´ã€‚' },
      { title: 'ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿', text: 'ãƒ‡ãƒ¼ã‚¿ãŒæ•£åœ¨ã—æ´»ç”¨ãŒé€²ã¾ãªã„ã€‚æ¨™æº–APIã¨ã‚«ã‚¿ãƒ­ã‚°æ•´å‚™ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿çµ±ä¸€ã§å†åˆ©ç”¨æ€§ã‚’é«˜ã‚ã‚‹ã€‚æ°‘é–“åˆ©æ´»ç”¨äº‹ä¾‹ã®å‰µå‡ºã‚’ä¿ƒé€²ã€‚' },
      { title: 'ã‚¹ãƒãƒ¼ãƒ„æ–½è¨­æ”¹ä¿®', text: 'è€æœ½åŒ–ã¨ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼æœªå¯¾å¿œã€‚åºŠé¢æ›´æ–°ã€ç©ºèª¿æ”¹å–„ã€ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«åŒ–ã§åˆ©ç”¨è€…æº€è¶³ã‚’å‘ä¸Šã™ã‚‹ã€‚ç¨¼åƒç‡ã¨å¤§ä¼šèª˜è‡´ã®å¢—åŠ ã‚’ç›®æŒ‡ã™ã€‚' },
      { title: 'æ–‡åŒ–è²¡ä¿å­˜', text: 'é¢¨åŒ–ã¨ç½å®³ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚‹ã€‚ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–åŒ–ã¨è€éœ‡è£œå¼·ã€å±•ç¤ºç’°å¢ƒã®æ”¹å–„ã‚’è¡Œã†ã€‚æ¥é¤¨è€…ä½“é¨“ã®å‘ä¸Šã¨ç¶™æ‰¿ã‚’å›³ã‚‹ã€‚' },
    ];

    function renderExamples(){
      const box = document.getElementById('examples_box');
      if (!box) return;
      let html = '<div class="examples-title">ä¾‹ã‹ã‚‰é¸ã¶ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ¦‚è¦ã«æŒ¿å…¥ï¼‰</div><div class="examples-grid">';
      EXAMPLES.forEach((ex, i)=>{
        html += `\n<div class=\"example-card\" onclick=\"insertExample(${i})\">\n  <div class=\"example-title\">${ex.title}</div>\n  <div class=\"example-text\">${ex.text}</div>\n  <div class=\"example-actions\">\n    <button class=\"chip-btn\" type=\"button\">æŒ¿å…¥</button>\n    <button class=\"chip-btn\" type=\"button\" onclick=\"event.stopPropagation(); insertAndPredict(${i})\">æŒ¿å…¥ã—ã¦äºˆæ¸¬</button>\n  </div>\n</div>`;
      });
      html += '</div>';
      box.innerHTML = html;
    }

    function insertExample(i){
      const ex = EXAMPLES[i]; if (!ex) return;
      const ta = document.getElementById('input_gaiyo');
      if (ta) { ta.value = ex.text; }
    }
    function insertAndPredict(i){
      insertExample(i);
      predictFromInputs();
    }

    async function showActualThisMonth(){
      const box = document.getElementById('actual_month_box');
      if (!box) return;
      if (!window.CURRENT_EVENT_ID || window.ALLOCATED_EVENT_ID !== window.CURRENT_EVENT_ID) {
        alert('ä»Šã¯è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ï¼ˆã“ã®æœˆã®äº‹æ¥­ã«äºˆç®—ã‚’å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„ï¼‰');
        return;
      }
      box.textContent = 'loading actual...';
      try{
        const curId = String(window.CURRENT_EVENT_ID);
        const meta = await api(`/v1/events/meta?budget_id=${encodeURIComponent(curId)}`);
        const actualInit = meta['å½“åˆäºˆç®—'] ?? meta['tosho_yosan'];
        const actualName = meta['äº‹æ¥­å'] ?? meta['jigyo_mei'] ?? '';
        box.innerHTML = `
<section class="summary-kpi-section">
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ“Œ</div>
      <div class="kpi-content">
        <h3>ä»Šæœˆã®å½“åˆäºˆç®—</h3>
        <div class="kpi-value">${yen(actualInit)} å††</div>
      </div>
    </div>
  </div>
</section>
<div class="muted">äº‹æ¥­å: ${actualName}</div>`;
      }catch(e){
        box.textContent = 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    }

    async function resetOverview(){
      try { localStorage.removeItem(S_KEY); } catch {}
      await loadOverview();
      // Re-enable next button just in case
      const btn = document.getElementById('btn_next_overview');
      if (btn) btn.disabled = false;
    }

    async function loadMetrics(){
      const box = document.getElementById('metrics_box');
      const lineBox = document.getElementById('metrics_line_box');
      if (!box) return;
      if (!window.SESSION_ID) { box.innerHTML = '<span class="muted">å…ˆã«ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</span>'; return; }
      box.innerHTML = 'loading metrics...';
      try{
        const data = await api(`/v1/metrics/months?session_id=${encodeURIComponent(window.SESSION_ID)}`);
        const months = Array.isArray(data.months) ? data.months : [];
        // ã‚¹ã‚±ãƒ¼ãƒ«ç”¨ã«æœ€å¤§å€¤ã‚’ç®—å‡ºï¼ˆactual/allocated/aiã®æœ€å¤§ï¼‰
        let maxVal = 0;
        for (const m of months){
          for (const v of [m.actual_initial, m.allocated, m.ai_reference]){
            const f = Number(v);
            if (!isNaN(f) && f > maxVal) maxVal = f;
          }
        }
        if (!(maxVal > 0)) maxVal = 1;
        const pct = (v)=>`${Math.max(0, Math.min(100, (Number(v||0)/maxVal)*100))}%`;

        let html = '';
        html += '<div class="metrics-legend">'
          + '<span><span class="box" style="background:#64748b"></span>å®Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆå½“åˆï¼‰</span>'
          + '<span><span class="box" style="background:#60a5fa"></span>å‰²å½“</span>'
          + '<span><span class="box" style="background:rgba(34,197,94,.25); border:1px solid rgba(34,197,94,.35)"></span>è¨±å®¹å¸¯ (Â±20%)</span>'
          + '<span><span class="box" style="background:#f59e0b"></span>AIå‚è€ƒå€¤</span>'
          + '</div>';
        for (const m of months){
          const low = m.tolerance_low, high = m.tolerance_high;
          const left = Math.min(low ?? 0, high ?? 0);
          const right = Math.max(low ?? 0, high ?? 0);
          const bandLeft = pct(left);
          const bandWidth = `calc(${pct(right)} - ${bandLeft})`;
          const aiLeft = pct(m.ai_reference);
          const actualW = pct(m.actual_initial);
          const allocW = pct(m.allocated);
          html += '<div class="metrics-row">'
            + `<div class="metrics-label">${m.month}</div>`
            + '<div class="metrics-track">'
              + `<div class="metrics-band" style="left:${bandLeft}; width:${bandWidth}"></div>`
              + (m.allocated!=null? `<div class=\"metrics-bar actual\" style=\"width:${actualW}\"></div>` : '')
              + (m.allocated!=null? `<div class="metrics-bar alloc" style="width:${allocW}"></div>` : '')
              + (m.ai_reference!=null? `<div class="metrics-marker ai" style="left:${aiLeft}"></div>` : '')
            + '</div>'
            + `<div class=\"metrics-values\">${m.name? m.name : ''} ${(m.allocated!=null && m.actual_initial!=null)? 'å®Ÿ:'+yen(m.actual_initial):''} ${m.allocated!=null? ' å‰²å½“:'+yen(m.allocated):''} ${m.ai_reference!=null? ' AI:'+yen(m.ai_reference):''}</div>`
            + '</div>';
        }
        box.innerHTML = html;
        if (lineBox) { lineBox.innerHTML = renderLineChartFromSeries(); }
      }catch(e){
        box.innerHTML = `error: ${e.status || ''}`;
      }
    }

    // è¿½åŠ å¼ æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•
    function resetLineSeries(){
      window.LINE_SERIES = { user: Array(12).fill(null), actual: Array(12).fill(null), names: {} };
      const box = document.getElementById('metrics_line_box');
      if (box) box.innerHTML = renderLineChartFromSeries();
    }

    function appendLinePoint(month, allocated, actual, name){
      if (!window.LINE_SERIES) resetLineSeries();
      const i = Math.max(1, Math.min(12, parseInt(month||0))) - 1;
      if (isNaN(i) || i<0 || i>11) return;
      if (allocated!=null && !isNaN(Number(allocated))) window.LINE_SERIES.user[i] = Number(allocated);
      if (actual!=null && !isNaN(Number(actual))) window.LINE_SERIES.actual[i] = Number(actual);
      if (name) window.LINE_SERIES.names[String(i+1)] = String(name);
      const box = document.getElementById('metrics_line_box');
      if (box) box.innerHTML = renderLineChartFromSeries();
    }

    function renderLineChartFromSeries(){
      const S = window.LINE_SERIES || { user: [], actual: [], names: {} };
      const months = [...Array(12)].map((_,i)=>i+1);
      const box = document.getElementById('metrics_line_box');
      const cw = Math.max(720, (box?.clientWidth || 760));
      const W = cw, H = Math.round(cw * 0.38); // responsive height
      const M = 48; // margin
      const iw = W - M*2, ih = H - M*2;
      const values = [];
      (S.user||[]).forEach(v=>{ const f=Number(v); if(!isNaN(f)) values.push(f); });
      (S.actual||[]).forEach(v=>{ const f=Number(v); if(!isNaN(f)) values.push(f); });
      const maxV = Math.max(1, ...(values.length? values : [1]));
      const minV = 0; // start at zero
      const x = (i)=> M + (iw * (i/(Math.max(1, months.length-1))))
      const y = (v)=> M + ih - (ih * ((Number(v||0)-minV)/(maxV-minV||1)))
      function mkPath(arr){
        let d=''; let lastDefined=false;
        months.forEach((m, idx)=>{
          const v = (arr||[])[idx];
          if (v==null || isNaN(Number(v))) { lastDefined=false; return; }
          const X=x(idx), Y=y(v);
          if (!lastDefined) { d += `M ${X} ${Y}`; lastDefined=true; }
          else { d += ` L ${X} ${Y}`; }
        });
        return d || 'M 0 0';
      }
      // grid lines (5 ticks)
      const ticks = 5; let grid = '';
      for(let i=0;i<=ticks;i++){
        const v = minV + (maxV-minV)*(i/ticks);
        const Y = y(v);
        grid += `<line x1="${M}" y1="${Y}" x2="${W-M}" y2="${Y}" class="lc-grid" />`;
        grid += `<text x="${W-M+6}" y="${Y+4}" fill="#94a3b8" font-size="12">${yen(v)}</text>`;
      }
      // x labels (months)
      let xlabels='';
      months.forEach((m, idx)=>{
        const X = x(idx);
        xlabels += `<text x="${X}" y="${H-10}" fill="#94a3b8" font-size="12" text-anchor="middle">${m}</text>`;
      });
      const pathActual = mkPath(S.actual);
      const pathUser = mkPath(S.user);
      // å·®åˆ†ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆä¸¡æ–¹ã‚ã‚‹æœˆã«ç¸¦å¸¯ + å·®ã®ãƒ©ãƒ™ãƒ«ï¼‰
      let diffs='';
      const segW = Math.max(12, iw/12*0.7);
      // æœ€æ–°ã®ãƒ—ãƒ­ãƒƒãƒˆæœˆã‚’ç‰¹å®š
      let lastIdx = -1;
      for (let i=months.length-1;i>=0;i--){
        const av = (S.actual||[])[i];
        const uv = (S.user||[])[i];
        if ((av!=null && !isNaN(Number(av))) || (uv!=null && !isNaN(Number(uv)))) { lastIdx = i; break; }
      }
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¸¯ï¼ˆæœ€æ–°æœˆã®èƒŒæ™¯ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
      let focusBand='';
      if (lastIdx >= 0){
        const Xc = x(lastIdx);
        const X = Xc - (segW*0.85);
        focusBand = `<rect x="${X}" y="${M}" width="${segW*1.7}" height="${ih}" class="lc-focus" />`;
      }
      months.forEach((m, idx)=>{
        const av = (S.actual||[])[idx];
        const uv = (S.user||[])[idx];
        if (av==null || uv==null || isNaN(Number(av)) || isNaN(Number(uv))) return;
        const X = x(idx) - (segW/2); // æœˆã®ä¸­å¿ƒã‚’åŸºæº–ã«å¤ªã„å¸¯ã«
        const top = y(Math.max(av, uv));
        const bot = y(Math.min(av, uv));
        const h = Math.max(2, bot - top);
        diffs += `<rect x="${X}" y="${top}" width="${segW}" height="${h}" class="lc-band-diff"><title>${m}æœˆ å·®:${yen(Math.abs(uv-av))}</title></rect>`;
        // å·®åˆ†ãƒ©ãƒ™ãƒ«ï¼ˆä¸Šå´ã«å°ã•ãï¼‰
        const labelY = top - 6;
        diffs += `<text x="${X+segW/2}" y="${labelY}" text-anchor="middle" class="lc-diff-label">Î”${yen(Math.abs(uv-av))}</text>`;
      });
      // points + value labels + pulse for latest
      let pts='';
      let labels='';
      let pulses='';
      months.forEach((m, idx)=>{
        const X=x(idx);
        const name = (S.names||{})[String(idx+1)] || '';
        const av = (S.actual||[])[idx];
        const uv = (S.user||[])[idx];
        if (av!=null && !isNaN(Number(av))) {
          const Ya = y(av);
          pts += `<g class="lc-point actual"><circle cx="${X}" cy="${Ya}" r="5" /><title>${m}æœˆ å®Ÿ:${yen(av)}\n${name}</title></g>`;
          labels += `<text class="lc-val actual ${idx===lastIdx?'highlight':''}" x="${X+10}" y="${Ya-6}">${yen(av)}</text>`;
          if (idx===lastIdx){
            pulses += `<g class="lc-pulse actual" transform="translate(${X},${Ya})"><circle class="pulse-ring" r="6" /></g>`;
          }
        }
        if (uv!=null && !isNaN(Number(uv))) {
          const Yu = y(uv);
          pts += `<g class="lc-point alloc"><circle cx="${X}" cy="${Yu}" r="5" /><title>${m}æœˆ æƒ³å®š:${yen(uv)}\n${name}</title></g>`;
          labels += `<text class="lc-val alloc ${idx===lastIdx?'highlight':''}" x="${X+10}" y="${Yu+14}">${yen(uv)}</text>`;
          if (idx===lastIdx){
            pulses += `<g class="lc-pulse alloc" transform="translate(${X},${Yu})"><circle class="pulse-ring" r="6" /></g>`;
          }
        }
      });
      // defs: gradients + glow filters
      const defs = `
<defs>
  <linearGradient id="gradActual" x1="0" y1="0" x2="1" y2="0">
    <stop offset="0%" stop-color="#ffffff"/>
    <stop offset="100%" stop-color="#e5e7eb"/>
  </linearGradient>
  <linearGradient id="gradAlloc" x1="0" y1="0" x2="1" y2="0">
    <stop offset="0%" stop-color="#22d3ee"/>
    <stop offset="100%" stop-color="#60a5fa"/>
  </linearGradient>
  <filter id="glowActual" x="-50%" y="-50%" width="200%" height="200%">
    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
    <feMerge>
      <feMergeNode in="coloredBlur"/>
      <feMergeNode in="SourceGraphic"/>
    </feMerge>
  </filter>
  <filter id="glowAlloc" x="-50%" y="-50%" width="200%" height="200%">
    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
    <feMerge>
      <feMergeNode in="coloredBlur"/>
      <feMergeNode in="SourceGraphic"/>
    </feMerge>
  </filter>
</defs>`;

      return `
<div class="linechart-legend">
  <span><span class="box" style="background:#64748b"></span>å®Ÿãƒ‡ãƒ¼ã‚¿</span>
  <span><span class="box" style="background:#60a5fa"></span>ãƒ¦ãƒ¼ã‚¶æƒ³å®šäºˆç®—</span>
</div>
<svg class="lc-svg" viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">
  ${defs}
  <rect x="0" y="0" width="${W}" height="${H}" fill="none" />
  ${grid}
  <line x1="${M}" y1="${M}" x2="${M}" y2="${H-M}" class="lc-axis" />
  <line x1="${M}" y1="${H-M}" x2="${W-M}" y2="${H-M}" class="lc-axis" />
  ${xlabels}
  ${focusBand}
  ${diffs}
  <path d="${pathActual}" class="lc-line actual" stroke="url(#gradActual)" filter="url(#glowActual)" />
  <path d="${pathUser}" class="lc-line alloc" stroke="url(#gradAlloc)" filter="url(#glowAlloc)" />
  ${pulses}
  ${pts}
  ${labels}
</svg>`;
    }
  </script>
</head>
<body onload="loadOverview(); renderExamples()">
  <header class="header">
    <div class="header-content">
      <div class="app-title">Policy Game</div>
      <div class="header-actions">
        <button class="btn btn-outline" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        <button class="btn btn-outline" id="btn_next_month" onclick="nextMonth()" disabled aria-disabled="true" title="ã“ã®æœˆã®äº‹æ¥­ã«å‰²å½“ã‚’è¡Œã†ã¨æ¬¡ã¸é€²ã‚ã¾ã™">æ¬¡ã®æœˆã¸</button>
        <span id="next_hint" class="next-hint">ã“ã®æœˆã®äº‹æ¥­ã«å‰²å½“ã‚’è¡Œã†ã¨æ¬¡ã¸é€²ã‚ã¾ã™</span>
      </div>
    </div>
  </header>

  <main class="main-content">
    <section class="card highlight-card">
      <div class="card-title">äºˆç®—ã®æ¨ç§»ï¼ˆãƒ¦ãƒ¼ã‚¶æƒ³å®š vs å®Ÿï¼‰</div>
      <div id="metrics_line_box" class="linechart-section"></div>
    </section>
    <div class="two-column-layout">
      <section id="leftpane" class="card">
        <div class="card-title">ä»Šæœˆã®äº‹æ¥­</div>
        <div class="actions">
          <span class="muted" id="period_label"></span>
        </div>
        <div id="overview_content" class="result"></div>
        <div class="card-title" style="margin-top:14px">å…¥åŠ›</div>
        <div class="project-form">
          <div class="form-group">
            <label for="input_gaiyo">äº‹æ¥­ã®æ¦‚è¦</label>
            <textarea id="input_gaiyo" rows="6" placeholder="äº‹æ¥­ã®æ¦‚è¦ã‚’å…¥åŠ›"></textarea>
          </div>
          <div id="examples_box" class="examples"></div>
          <div class="form-group">
            <label for="alloc_input">ã“ã®äº‹æ¥­ã¸ã®å‰²å½“é¡ï¼ˆå††ï¼‰</label>
            <input type="number" id="alloc_input" placeholder="ä¾‹: 5000000000" />
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" onclick="predictFromInputs()">ã“ã®å†…å®¹ã§äºˆæ¸¬</button>
            <button class="btn btn-secondary" onclick="allocateBudget()">ã“ã®äº‹æ¥­ã«å‰²å½“</button>
          </div>
        </div>
        <input type="hidden" id="query_text" />
      </section>
      <section id="rightpane" class="card">
        <div class="card-title">äºˆç®—æ¨å®šãƒ»é¡ä¼¼äº‹æ¥­</div>
        <section class="summary-kpi-section">
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-icon">ğŸ“…</div>
              <div class="kpi-content">
                <h3>å¹´åº¦</h3>
                <div class="kpi-value" id="kpi_year">-</div>
              </div>
            </div>
            <div class="kpi-card">
              <div class="kpi-icon">ğŸ’µ</div>
              <div class="kpi-content">
                <h3>å¹´åº¦æ®‹é¡</h3>
                <div class="kpi-value" id="kpi_remaining">- å††</div>
              </div>
            </div>
          </div>
        </section>
        
        <div class="actions" style="margin:8px 0">
          <button class="btn small" id="btn_show_actual" onclick="showActualThisMonth()">ä»Šæœˆã®äº‹æ¥­ã®å½“åˆäºˆç®—ã‚’ç¢ºèª</button>
          <span id="actual_month_box" class="muted" style="margin-left:8px"></span>
        </div>
        <div id="pred" class="projects-list"></div>

        
      </section>
    </div>

    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detail_modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="detail_title">è©³ç´°</h3>
          <button class="modal-close" onclick="closeDetail()">Ã—</button>
        </div>
        <div class="modal-body" id="detail_body"></div>
      </div>
    </div>

    
  </main>

  <footer class="site-footer">
    <div class="container">
      <span class="muted">Â© Policy Game Demo</span>
    </div>
  </footer>
</body>
</html>
